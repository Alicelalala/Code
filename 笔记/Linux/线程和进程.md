### 线程和进程

```
1、定义：什么是线程，什么是进程？

进程:具有一定独立功能的程序关于某个数据集合上的一次运行活动,进程是系统进行资源分配和调度的一个独立单位.

线程:进程的一个实体,是CPU调度和分派的基本单位,它是比进程更小的能独立运行的基本单位.线程自己基本上不拥有系统资源,只拥有一点在运行中必不可少的资源(如程序计数器,一组寄存器和栈),但是它可与同属一个进程的其他的线程共享进程所拥有的全部资源.

进程：是执行中一段程序，即一旦程序【被载入到内存】中并准备执行，它就是一个进程。进程是表示资源分配的的基本概念，又是调度运行的基本单位，是系统中的【并发执行】的单位。

线程：单个进程中执行中【每个任务】就是一个线程。【线程是进程中执行运算的最小单位】。

进程——【资源分配】的最小单位，线程——【程序执行】的最小单位。

2、一个线程只能属于一个进程，但是一个进程可以拥有多个线程。多线程处理就是允许【一个进程中在同一时刻执行多个任务】。

3、线程是一种轻量级的进程，与进程相比，线程给操作系统带来侧创建、维护、和管理的负担要轻，意味着线程的代价或开销比较小。

4、线程【没有地址空间】，线程包含在进程的地址空间中。线程上下文只包含一个堆栈、一个寄存器、一个优先权，线程文本包含在他的进程的文本片段中，进程拥有的所有资源都属于线程。【所有的线程共享进程的内存和资源】。 同一进程中的【多个线程共享代码段(代码和常量)，数据段(全局变量和静态变量)，扩展段(堆存储)】。但是每个线程拥有自己的栈段， 寄存器的内容，栈段又叫运行时段，用来存放所有局部变量和临时变量。

5、父和子进程使用进程间通信机制，同一进程的线程通过读取和写入数据到进程变量来通信。

6、进程内的任何线程都被看做是同位体，且处于相同的级别。不管是哪个线程创建了哪一个线程，进程内的任何线程都可以销毁、挂起、恢复和更改其它线程的优先权。线程也要对进程施加控制，进程中任何线程都可以通过销毁主线程来销毁进程，销毁主线程将导致该进程的销毁，对主线程的修改可能影响所有的线程。

7、子进程不对任何其他子进程施加控制，进程的线程可以对同一进程的其它线程施加控制。子进程不能对父进程施加控制，进程中所有线程都可以对主线程施加控制。

相同点：

进程和线程都有ID/寄存器组、状态和优先权、信息块，创建后都可更改自己的属性，都可与父进程共享资源、都不能直接访问其他无关进程或线程的资源。

```

```
进程与线程的选择取决以下几点：

1、需要频繁创建销毁的优先使用线程；因为对进程来说创建和销毁一个进程代价是很大的。

2、线程的切换速度快，所以在需要大量计算，切换频繁时用线程，还有耗时的操作使用线程可提高应用程序的响应

3、因为对CPU系统的效率使用上线程更占优，所以可能要发展到多机分布的用进程，多核分布用线程；

4、并行操作时使用线程，如C/S架构的服务器端并发线程响应用户的请求；

5、需要更稳定安全时，适合选择进程；需要速度时，选择线程更好。


```

##### 共享内存

```
共享内存是进程间通信中最简单的方式之中的一个。

共享内存是系统出于多个进程之间通讯的考虑，而预留的的一块内存区。

共享内存同意两个或很多其他进程訪问同一块内存，就如同 malloc() 函数向不同进程返回了指向同一个物理内存区域的指针。

当一个进程改变了这块地址中的内容的时候，其他进程都会察觉到这个更改。

当一个程序载入进内存后，它就被分成叫作页的块。

通信将存在内存的两个页之间或者两个独立的进程之间。

总之，当一个程序想和另外一个程序通信的时候。那内存将会为这两个程序生成一块公共的内存区域。这块被两个进程分享的内存区域叫做共享内存

由于全部进程共享同一块内存，共享内存在各种进程间通信方式中具有最高的效率。

防问共享内存区域和訪问进程独有的内存区域一样快，并不须要通过系统调用或者其他须要切入内核的过程来完毕。同一时候它也避免了对数据的各种不必要的复制。

假设没有共享内存的概念。那一个进程不能存取另外一个进程的内存部分。因而导致共享数据或者通信失效。由于系统内核没有对防问共享内存进行同步，您必须提供自己的同步措施。

解决这些问题的经常用法是通过使用信号量进行同步。

只是，我们的程序中仅仅有一个进程訪问了共享内存。因此在集中展示了共享内存机制的同一时候。我们避免了让代码被同步逻辑搞得混乱不堪。

为了简化共享数据的完整性和避免同一时候存取数据，内核提供了一种专门存取共享内存资源的机制。这称为相互排斥体或者mutex对象

比如。在数据被写入之前不同意进程从共享内存中读取信息、不同意两个进程同一时候向同一个共享内存地址写入数据等。

当一个进程想和另外一个进程通信的时候，它将按下面顺序运行：

获取mutex对象，锁定共享区域。

将要通信的数据写入共享区域。

释放mutex对象。

当一个进程从从这个区域读数据时候，它将反复相同的步骤，仅仅是将第二步变成读取。
```

```
共享内存的使用。主要有下面几个API：ftok()、shmget()、shmat()、shmdt()及shmctl()。

#include <sys/shm.h>
void *shmat(int shm_id, const void *shm_addr, int shmflg);
int shmctl(int shm_id, int cmd, struct shmid_ds *buf);
int shmdt(const void *shm_addr);
int shmget(key_t key, size_t size, int shmflg);
```

